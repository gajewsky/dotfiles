#!/bin/bash
set -e

# Add opencode to PATH for this script execution
export PATH="$HOME/.opencode/bin:$PATH"

# Install opencode if not present
if ! command -v opencode &> /dev/null; then
    echo "Installing opencode..."
{{ if eq .chezmoi.os "darwin" -}}
    # macOS - use Homebrew
    if command -v brew &> /dev/null; then
        brew install sst/tap/opencode
    else
        # Fallback to curl installer if brew not available
        curl -fsSL https://opencode.ai/install | bash
    fi
{{ else if eq .chezmoi.os "linux" -}}
    # Linux - use curl installer
    curl -fsSL https://opencode.ai/install | bash
{{ else -}}
    # Other platforms - try curl installer
    curl -fsSL https://opencode.ai/install | bash
{{ end -}}
else
    echo "opencode is already installed."
fi

# Verify installation
if command -v opencode &> /dev/null; then
    echo "opencode version:"
    opencode --version
else
    echo "Warning: opencode installation may have failed. You may need to add it to your PATH."
    echo "Try adding this to your shell config: export PATH=\"\$HOME/.opencode/bin:\$PATH\""
fi
