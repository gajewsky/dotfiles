{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Merge work-specific settings into Claude config
# Only runs on macOS (work machine)

SETTINGS_FILE="$HOME/.claude/settings.json"
GLOBAL_CONFIG="$HOME/.claude.json"
WORK_SETTINGS="$HOME/.claude/settings.work.json"

if [[ -f "$WORK_SETTINGS" ]] && command -v jq &> /dev/null; then
    # Merge non-MCP settings into settings.json
    jq -s '.[0] * (.[1] | del(.mcpServers))' "$SETTINGS_FILE" "$WORK_SETTINGS" > "$SETTINGS_FILE.tmp" && \
        mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
    echo "Merged work settings into ~/.claude/settings.json"

    # Merge MCP servers into global ~/.claude.json
    if [[ -f "$GLOBAL_CONFIG" ]]; then
        WORK_MCP=$(jq '.mcpServers // {}' "$WORK_SETTINGS")
        if [[ "$WORK_MCP" != "{}" ]]; then
            jq --argjson work "$WORK_MCP" '.mcpServers = (.mcpServers // {}) + $work' "$GLOBAL_CONFIG" > "$GLOBAL_CONFIG.tmp" && \
                mv "$GLOBAL_CONFIG.tmp" "$GLOBAL_CONFIG"
            echo "Merged MCP servers into ~/.claude.json"
        fi
    fi
else
    [[ ! -f "$WORK_SETTINGS" ]] && echo "No work settings found"
    ! command -v jq &> /dev/null && echo "Warning: jq not found"
fi
{{ end -}}
