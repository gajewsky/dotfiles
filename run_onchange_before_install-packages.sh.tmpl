#!/bin/bash
# Packages hash: {{ include "dot_config/fish/config.fish" | sha256sum }}

set -e

packages="fish fzf zoxide starship zellij neovim wget eza bat mise git-delta lazygit git-absorb fd ripgrep jq procs bottom glow xclip"

{{ if eq .chezmoi.os "darwin" -}}
packages="$packages gh"
{{ else -}}
packages="$packages github-cli"
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Homebrew
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

echo "Checking and installing packages..."
for package in $packages; do
    if ! brew list "$package" &> /dev/null; then
        echo "Installing $package..."
        brew install "$package"
    fi
done

{{ else if eq .chezmoi.os "linux" -}}
# Arch/Manjaro - pacman
if command -v pacman &> /dev/null; then
    echo "Checking and installing packages (pacman)..."
    for package in $packages; do
        if ! pacman -Qi "$package" &> /dev/null 2>&1; then
            echo "Installing $package..."
            sudo pacman -S --noconfirm "$package"
        fi
    done
else
    echo "Unsupported package manager. Please install packages manually:"
    echo "  $packages"
fi
{{- end }}

# Install Reef plugin manager if not already installed
if ! fish -c "type -q reef" &> /dev/null 2>&1; then
    echo "Installing Reef plugin manager..."
    fish -c 'curl -sL https://tinyurl.com/fish-reef | source && reef add danielb2/reef && reef init'
fi

# Install Reef plugins (corals)
echo "Installing Reef plugins..."
reef_plugins="jorgebucaran/autopair.fish gazorby/fish-abbreviation-tips PatrickF1/fzf.fish jhillyerd/plugin-git jorgebucaran/replay.fish meaningful-ooo/sponge"

for plugin in $reef_plugins; do
    if ! fish -c "reef list" 2>/dev/null | grep -q "$plugin"; then
        echo "Installing $plugin..."
        fish -c "reef add $plugin"
    fi
done

# Fix jhillyerd/plugin-git for Reef compatibility (has Fisher-specific init code)
git_conf="$HOME/.config/fish/corals/jhillyerd/plugin/conf.d/git.fish"
if [ -f "$git_conf" ] && grep -q "fisher_path" "$git_conf"; then
    echo "Patching jhillyerd/plugin-git for Reef compatibility..."
    cat > "$git_conf" << 'GITFISH'
# Remove legacy hooks to prevent errors when upgrading.
# This can be removed when we cleanup other universal abbr code.
functions -e _git_install _git_update _git_uninstall

# Initialize git abbreviations (works with Fisher, OMF, and Reef)
if type -q __git.init
  __git.init
end
GITFISH
fi

echo "All packages installed!"
